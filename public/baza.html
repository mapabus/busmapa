import { google } from 'googleapis';

export default async function handler(req, res) {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  console.log('=== Google Sheets Update Request ===');
  
  try {
    const { vehicles } = req.body;

    if (!vehicles || !Array.isArray(vehicles)) {
      console.error('Invalid data format');
      return res.status(400).json({ error: 'Invalid data format' });
    }

    console.log(`Received ${vehicles.length} vehicles`);

    const clientEmail = process.env.GOOGLE_SHEETS_CLIENT_EMAIL;
    const privateKey = process.env.GOOGLE_SHEETS_PRIVATE_KEY;
    const spreadsheetId = process.env.GOOGLE_SPREADSHEET_ID;

    if (!clientEmail || !privateKey || !spreadsheetId) {
      return res.status(500).json({ 
        error: 'Missing environment variables'
      });
    }

    let formattedPrivateKey = privateKey;
    if (privateKey.includes('\\n')) {
      formattedPrivateKey = privateKey.replace(/\\n/g, '\n');
    }

    const auth = new google.auth.GoogleAuth({
      credentials: {
        client_email: clientEmail,
        private_key: formattedPrivateKey,
      },
      scopes: ['https://www.googleapis.com/auth/spreadsheets'],
    });

    const sheets = google.sheets({ version: 'v4', auth });

    // Kreiraj timestamp za datum i vreme
    const timestamp = new Date().toLocaleString('sr-RS', { 
      timeZone: 'Europe/Belgrade',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    const sheetName = 'Sheet1';

    // Prvo pročitaj postojeće podatke
    let existingData = [];
    try {
      const readResponse = await sheets.spreadsheets.values.get({
        spreadsheetId,
        range: `${sheetName}!A2:F`,
      });
      existingData = readResponse.data.values || [];
      console.log(`Found ${existingData.length} existing rows`);
    } catch (readError) {
      console.log('No existing data or read error:', readError.message);
    }

    // Kreiraj mapu postojećih vozila (vozilo -> row index)
    const existingVehicles = new Map();
    existingData.forEach((row, index) => {
      if (row[0]) { // Ako postoji broj vozila
        existingVehicles.set(row[0], {
          rowIndex: index + 2, // +2 jer počinje od A2
          data: row
        });
      }
    });

    let newCount = 0;
    let updateCount = 0;

    // Proces svako vozilo
    for (const v of vehicles) {
      const vehicleLabel = v.vehicleLabel || '';
      const rowData = [
        vehicleLabel,
        v.routeDisplayName || '',
        v.startTime || '',
        v.destName || '',
        timestamp,  // Kolona E - vreme upisa
        timestamp.split(',')[0].trim()  // Kolona F - samo datum
      ];

      if (existingVehicles.has(vehicleLabel)) {
        // AŽURIRAJ postojeći red
        const existingRow = existingVehicles.get(vehicleLabel);
        try {
          await sheets.spreadsheets.values.update({
            spreadsheetId,
            range: `${sheetName}!A${existingRow.rowIndex}:F${existingRow.rowIndex}`,
            valueInputOption: 'RAW',
            resource: {
              values: [rowData]
            }
          });
          updateCount++;
          console.log(`Updated vehicle ${vehicleLabel} at row ${existingRow.rowIndex}`);
        } catch (updateError) {
          console.error(`Error updating ${vehicleLabel}:`, updateError.message);
        }
      } else {
        // DODAJ novi red
        try {
          await sheets.spreadsheets.values.append({
            spreadsheetId,
            range: `${sheetName}!A2`,
            valueInputOption: 'RAW',
            insertDataOption: 'INSERT_ROWS',
            resource: {
              values: [rowData]
            }
          });
          newCount++;
          console.log(`Added new vehicle ${vehicleLabel}`);
          
          // Dodaj u mapu da ne dodamo duplikat u istom batch-u
          existingVehicles.set(vehicleLabel, { rowIndex: -1, data: rowData });
        } catch (appendError) {
          console.error(`Error adding ${vehicleLabel}:`, appendError.message);
        }
      }
    }

    // VAŽNO: Sortiraj Sheet NAKON SVAKOG upisa (ne samo kada ima novih)
    try {
      // Prvo dobavi sheet ID
      const sheetMetadata = await sheets.spreadsheets.get({
        spreadsheetId,
      });
      
      const sheet = sheetMetadata.data.sheets.find(
        s => s.properties.title === sheetName
      );
      
      if (!sheet) {
        throw new Error(`Sheet "${sheetName}" not found`);
      }

      const sheetId = sheet.properties.sheetId;

      // Sortiraj po koloni A (vozilo) - numerički
      await sheets.spreadsheets.batchUpdate({
        spreadsheetId,
        resource: {
          requests: [
            {
              sortRange: {
                range: {
                  sheetId: sheetId,
                  startRowIndex: 1, // Počinje od reda 2 (index 1)
                  startColumnIndex: 0,
                  endColumnIndex: 6, // Kolone A do F
                },
                sortSpecs: [
                  {
                    dimensionIndex: 0, // Sortiraj po koloni A (vozilo)
                    sortOrder: 'ASCENDING',
                  },
                ],
              },
            },
          ],
        },
      });
      console.log('✓ Sheet sortiran po broju vozila');
    } catch (sortError) {
      console.error('✗ Greška pri sortiranju:', sortError.message);
    }

    console.log('=== Update Complete ===');

    res.status(200).json({ 
      success: true, 
      newVehicles: newCount,
      updatedVehicles: updateCount,
      totalProcessed: vehicles.length,
      timestamp,
      sheetUsed: sheetName,
      sorted: true
    });

  } catch (error) {
    console.error('Unexpected error:', error);
    res.status(500).json({ 
      error: 'Unexpected error',
      details: error.message
    });
  }
}
