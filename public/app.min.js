

class BusMapApp {
  constructor(config) {
    this.map = L.map('map').setView(config.mapCenter, config.mapZoom);
    this.markersLayer = L.layerGroup().addTo(this.map);
    this.colors = config.colors;
    this.directionColorMap = {};
    this.allMarkers = {};
    this.stationsMap = {};
    this.routeNamesMap = {};
    this.refreshInterval = config.refreshInterval;
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(this.map);
    
    this.init();
  }

  async init() {
    await this.loadStations();
    await this.loadRouteNames();
    this.loadVehicles();
    this.startAutoRefresh();
  }

  async loadStations() {
    const response = await fetch('/api/stations');
    this.stationsMap = await response.json();
  }

  async loadRouteNames() {
    const response = await fetch('/route-mapping.json');
    this.routeNamesMap = await response.json();
  }

  async loadVehicles() {
    document.getElementById('loadingCard').classList.remove('hidden');
    
    const response = await fetch('/api/vehicles');
    const data = await response.json();
    
    document.getElementById('loadingCard').classList.add('hidden');
    
    if (data && data.vehicles) {
      const vehicleDestinations = {};
      data.tripUpdates.forEach(update => {
        vehicleDestinations[update.vehicleId] = update.destination;
      });
      
      this.drawMarkers(data.vehicles, vehicleDestinations);
    }
  }

  drawMarkers(vehicles, vehicleDestinations) {
    this.markersLayer.clearLayers();
    this.allMarkers = {};
    
    vehicles.forEach(vehicle => {
      const routeNum = parseInt(vehicle.routeId);
      const routeDisplayName = this.getRouteDisplayName(vehicle.routeId);
      const destId = vehicleDestinations[vehicle.id] || "Unknown";
      const normalizedId = this.normalizeStopId(destId);
      const station = this.stationsMap[normalizedId];
      const destName = station ? station.name : destId;
      
      const uniqueDirKey = `${routeNum}_${destId}`;
      
      if (!this.directionColorMap[uniqueDirKey]) {
        const nextColorIndex = Object.keys(this.directionColorMap).length % this.colors.length;
        this.directionColorMap[uniqueDirKey] = this.colors[nextColorIndex];
      }
      
      const markerColor = this.directionColorMap[uniqueDirKey];
      
      let rotation = 0;
      let hasAngle = false;

      if (station && station.coords) {
        rotation = this.calculateBearing(vehicle.lat, vehicle.lon, station.coords[0], station.coords[1]);
        hasAngle = true;
      }

      const arrowDisplay = hasAngle ? 'block' : 'none';

      const iconHtml = `
        <div class="bus-wrapper">
          <div class="bus-arrow" style="transform: rotate(${rotation}deg); display: ${arrowDisplay};">
            <div class="arrow-head" style="border-bottom-color: ${markerColor}; filter: brightness(0.6);"></div>
          </div>
          <div class="bus-circle" style="background: ${markerColor};">
            ${routeDisplayName}
          </div>
          <div class="bus-garage-label">${vehicle.label}</div>
        </div>
      `;

      const customIcon = L.divIcon({
        className: 'bus-icon-container',
        html: iconHtml,
        iconSize: [50, 56],
        iconAnchor: [25, 28]
      });

      const marker = L.marker([vehicle.lat, vehicle.lon], {icon: customIcon});

      const popupContent = `
        <div class="popup-content">
          <div class="popup-row"><span class="popup-label">Linija:</span> <b>${routeDisplayName}</b></div>
          <div class="popup-row"><span class="popup-label">Vozilo:</span> ${vehicle.label}</div>
          <div class="popup-row"><span class="popup-label">Polazak:</span> ${vehicle.startTime}</div>
          <hr style="margin: 5px 0; border-color:#eee;">
          <div class="popup-row"><span class="popup-label">Smer (ide ka):</span> <span style="color:${markerColor}; font-weight:bold;">${destName}</span></div>
        </div>
      `;
      
      marker.bindPopup(popupContent);
      this.markersLayer.addLayer(marker);
      
      this.allMarkers[vehicle.label] = {
        marker: marker,
        lat: vehicle.lat,
        lon: vehicle.lon,
        routeNum: routeNum,
        routeDisplayName: routeDisplayName,
        vehicleLabel: vehicle.label,
        startTime: vehicle.startTime,
        destName: destName
      };
    });
  }

  normalizeStopId(stopId) {
    if (typeof stopId === 'string' && stopId.length === 5 && stopId.startsWith('2')) {
      let normalized = stopId.substring(1);
      normalized = parseInt(normalized, 10).toString();
      return normalized;
    }
    return stopId;
  }

  normalizeRouteId(routeId) {
    if (typeof routeId === 'string') {
      return parseInt(routeId, 10).toString();
    }
    return routeId;
  }

  getRouteDisplayName(routeId) {
    const normalizedId = this.normalizeRouteId(routeId);
    return this.routeNamesMap[normalizedId] || normalizedId;
  }

  calculateBearing(startLat, startLng, destLat, destLng) {
    const y = Math.sin((destLng - startLng) * Math.PI / 180) * Math.cos(destLat * Math.PI / 180);
    const x = Math.cos(startLat * Math.PI / 180) * Math.sin(destLat * Math.PI / 180) -
              Math.sin(startLat * Math.PI / 180) * Math.cos(destLat * Math.PI / 180) * Math.cos((destLng - startLng) * Math.PI / 180);
    const brng = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
    return brng;
  }

  startAutoRefresh() {
    setInterval(() => {
      this.loadVehicles();
    }, this.refreshInterval);
  }

  searchVehicles(query) {
    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = '';
    
    if (!query || query.trim() === '') return;
    
    const searchTerm = query.toLowerCase().trim();
    const matchedVehicles = [];
    
    for (let vehicleLabel in this.allMarkers) {
      if (vehicleLabel.toLowerCase().includes(searchTerm)) {
        matchedVehicles.push(this.allMarkers[vehicleLabel]);
      }
    }
    
    const resultsToShow = matchedVehicles.slice(0, 2);
    
    resultsToShow.forEach(vehicle => {
      const resultItem = document.createElement('div');
      resultItem.className = 'search-result-item';
      resultItem.innerHTML = '<strong>Vozilo:</strong> ' + vehicle.vehicleLabel + 
                            '<br><small>Linija: ' + vehicle.routeDisplayName + '</small>';
      
      resultItem.onclick = () => {
        this.map.setView([vehicle.lat, vehicle.lon], 16);
        vehicle.marker.openPopup();
        document.getElementById('searchInput').value = '';
        resultsContainer.innerHTML = '';
      };
      
      resultsContainer.appendChild(resultItem);
    });
  }
}


async function initApp() {
  const configResponse = await fetch('/api/config');
  const config = await configResponse.json();
  
  window.busApp = new BusMapApp(config);
  
  document.getElementById('searchInput').addEventListener('input', function(e) {
    window.busApp.searchVehicles(e.target.value);
  });
}
